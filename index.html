<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Student AI - Smart Test</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg: var(--tg-theme-bg-color, #f4f7f6);
            --text: var(--tg-theme-text-color, #2c3e50);
            --hint: var(--tg-theme-hint-color, #95a5a6);
            --btn: var(--tg-theme-button-color, #3498db);
            --btn-text: var(--tg-theme-button-text-color, #ffffff);
            --sec-bg: var(--tg-theme-secondary-bg-color, #ffffff);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            width: 90%;
            max-width: 400px;
            background: var(--sec-bg);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .step { display: none; transition: all 0.3s ease; }
        .step.active { display: block; }

        input, select {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid var(--hint);
            border-radius: 10px;
            box-sizing: border-box;
            background: var(--bg);
            color: var(--text);
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--btn);
            color: var(--btn-text);
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }

        .option-btn {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--btn);
            margin-bottom: 10px;
            text-align: left;
            padding: 12px;
        }

        .option-btn:active { background: var(--btn); color: var(--btn-text); }

        .progress-bar {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-bottom: 20px;
        }
        .progress-fill {
            height: 100%;
            background: var(--btn);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="step1" class="step active">
        <h2>Ro'yxatdan o'tish</h2>
        <input type="text" id="name" placeholder="Ism va Familiyangiz">
        <select id="univ">
            <option value="">Universitetni tanlang</option>
            <option>Alfraganus Universiteti</option>
            <option>Perfect Universiteti</option>
            <option>TATU</option>
        </select>
        <select id="kurs">
            <option value="">Kursni tanlang</option>
            <option>1-kurs</option>
            <option>2-kurs</option>
        </select>
        <select id="yonalish">
            <option value="">Yo'nalishni tanlang</option>
            <option>Dasturiy Injiniring</option>
            <option>Kiberxavfsizlik</option>
            <option>Sun'iy intelekt</option>
        </select>
        <select id="semester">
            <option value="">Semestrni tanlang</option>
            <option value="1">1-semestr</option>
        </select>
        <button onclick="startTest()">Testni boshlash</button>
    </div>

    <div id="step2" class="step">
        <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        <h3 id="questionText">Savol yuklanmoqda...</h3>
        <div id="optionsContainer"></div>
    </div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    let currentQuestionIndex = 0;
    let score = 0;
    let testData = []; // Bu yerga savollar keladi

    async function startTest() {
    const name = document.getElementById('name').value;
    const yonalish = document.getElementById('yonalish').value;
    
    if(!name || !yonalish) {
        tg.showAlert("Iltimos, ismingiz va yo'nalishingizni tanlang!");
        return;
    }

    // Yo'nalish nomini JSON kalitiga moslash (avvalgi mantiqimiz)
    const yonalishKey = yonalish.toLowerCase().trim()
                        .replace(/'/g, '').replace(/ /g, '_') + "_academic"; 
                        // academic - bu misol uchun, buni dinamik qilish ham mumkin

    try {
        // SAVOLLARNI BOTDAN OLISH (API orqali)
        // Railway-dagi botingiz havolasini yozasiz
        const response = await fetch(`https://sizning-botingiz.railway.app/api/questions/${yonalishKey}`);
        const data = await response.json();

        if (data && data.questions) {
            testData = data.questions;
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            showQuestion();
        } else {
            tg.showAlert("Bu yo'nalishda savollar topilmadi!");
        }
    } catch (error) {
        tg.showAlert("Server bilan ulanishda xato!");
        console.error(error);
    }
}

    function showQuestion() {
        const q = testData[currentQuestionIndex];
        document.getElementById('questionText').innerText = q.q;
        const container = document.getElementById('optionsContainer');
        container.innerHTML = '';
        
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            container.appendChild(btn);
        });

        document.getElementById('progressFill').style.width = ((currentQuestionIndex / testData.length) * 100) + '%';
    }

    function checkAnswer(ans) {
        if(ans === testData[currentQuestionIndex].a) score++;
        
        currentQuestionIndex++;
        if(currentQuestionIndex < testData.length) {
            showQuestion();
        } else {
            finishTest();
        }
    }

    function finishTest() {
        tg.showConfirm(`Test tugadi! Ballingiz: ${score}. Natijani botga yuboraymi?`, (ok) => {
            if(ok) {
                tg.sendData(JSON.stringify({
                    user_name: document.getElementById('name').value,
                    total_score: score,
                    yonalish: document.getElementById('yonalish').value
                }));
            }
            tg.close();
        });
    }
</script>
</body>
</html>